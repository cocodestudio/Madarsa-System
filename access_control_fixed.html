<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-lang-key="page_title">Access Control - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --color-primary: #00a693;
        --color-background: #f2f3f4;
        --color-accent: #e08a27;
        --color-text-dark: #1a1a1a;
        --color-text-light: #ffffff;
      }

      /* FONT IMPORTS */
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Noto+Sans+Devanagari:wght@400;700&family=Noto+Nastaliq+Urdu:wght@400;700&display=swap");

      /* Language Styles */
      body,
      .lang-en {
        font-family: "Poppins", sans-serif;
        direction: ltr;
        background-color: var(--color-background);
      }

      .lang-hi {
        font-family: "Noto Sans Devanagari", sans-serif;
        direction: ltr;
      }

      .lang-ur {
        font-family: "Noto Nastaliq Urdu", "Segoe UI", Tahoma, Geneva, Verdana,
          sans-serif !important;
        direction: rtl;
        line-height: 1.8;
        text-align: right;
      }

      /* Form & Table Inputs */
      .form-input,
      select,
      .form-textarea {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid #ccc;
        width: 100%;
        font-family: inherit;
      }

      .form-input:focus,
      select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(0, 166, 147, 0.2);
      }

      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
      }

      /* Buttons */
      .primary-button {
        padding: 0.8rem 1.5rem;
        background-color: var(--color-primary);
        color: var(--color-text-light);
        font-weight: 600;
        border-radius: 0.75rem;
        transition: background-color 0.3s, transform 0.1s;
        box-shadow: 0 4px 10px rgba(0, 166, 147, 0.4);
        cursor: pointer;
      }

      .primary-button:hover {
        background-color: #008f7d;
        transform: translateY(-1px);
      }

      .action-button {
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: background-color 0.2s;
      }

      .delete-button {
        background-color: #fce8e8;
        color: #cc0000;
      }

      .delete-button:hover {
        background-color: #fcc;
      }

      /* Table Styling */
      .admin-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
      }

      .admin-table th {
        text-align: left;
        padding: 1rem 1.5rem;
        font-size: 0.875rem;
        color: gray;
        text-transform: uppercase;
        font-weight: 700;
      }

      .lang-ur .admin-table th {
        text-align: right;
      }

      .admin-table td {
        padding: 1rem 1.5rem;
        background-color: white;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        font-size: 0.8775rem;
        font-weight: 500;
      }

      .admin-table tr td:first-child {
        border-top-left-radius: 0.75rem;
        border-bottom-left-radius: 0.75rem;
      }

      .admin-table tr td:last-child {
        border-top-right-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
      }

      .lang-ur .admin-table tr td:first-child {
        border-radius: 0;
        border-top-right-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
      }

      .lang-ur .admin-table tr td:last-child {
        border-radius: 0;
        border-top-left-radius: 0.75rem;
        border-bottom-left-radius: 0.75rem;
      }

      /* Modal Styles */
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        transition: opacity 0.3s ease;
      }

      .modal-content {
        background-color: var(--color-background);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        border-radius: 1rem;
        max-width: 95%;
        width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }

      /* Fixed Header */
      header {
        background-color: var(--color-text-light);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        width: 100%;
        z-index: 10;
        padding: 1rem 2rem;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table-container table {
        min-width: 900px;
      }

      /* --- Accordion Styles (New) --- */
      .accordion-header {
        background-color: #fff;
        padding: 1rem 1.5rem;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        transition: background-color 0.2s;
      }

      .accordion-header:hover {
        background-color: #f9fafb;
      }

      .accordion-body {
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-top: none;
        margin-bottom: 0.5rem;
        transition: max-height 0.3s ease-out, opacity 0.3s ease;
        overflow: hidden;
        background-color: #fcfcfc;
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
      }

      .accordion-body.hidden-content {
        max-height: 0;
        opacity: 0;
        padding: 0 1rem;
        border: none;
      }

      .permission-item-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 0.5rem;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }

      @media (min-width: 640px) {
        .permission-item-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .permission-checkbox-item {
        display: flex;
        align-items: center;
        background-color: #fff;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: background-color 0.1s;
      }

      .permission-checkbox-item:hover {
        background-color: #f5f5f5;
      }

      .lang-ur .permission-checkbox-item {
        /* Flip checkbox order for RTL */
        flex-direction: row-reverse;
        justify-content: flex-end;
      }

      .lang-ur .permission-checkbox-item input {
        margin-right: 0;
        margin-left: 0.5rem;
      }
    </style>
  </head>

  <body class="lang-en">
    <script>
      // --- GLOBAL PERMISSION STRUCTURE (Based on API Response) ---
      const PERMISSION_STRUCTURE = {
        Academic: [
          { id: 5, name: "Manage Classes" },
          { id: 6, name: "View Students" },
          { id: 7, name: "Create Student" },
          { id: 8, name: "Edit Student" },
          { id: 9, name: "Delete Student" },
        ],
        Finance: [
          { id: 10, name: "View Fees" },
          { id: 11, name: "Collect Fee" },
          { id: 12, name: "Manage Expenses" },
        ],
        Staff: [
          { id: 1, name: "View Staff" },
          { id: 2, name: "Create Staff" },
          { id: 3, name: "Edit Staff" },
          { id: 4, name: "Delete Staff" },
          { id: 13, name: "Manage Roles" },
          { id: 14, name: "Manage Staff" },
        ],
      };

      const MODULES = Object.keys(PERMISSION_STRUCTURE); // ["Academic", "Finance", "Staff"]
      const ACCESS_STORAGE_KEY = "madarsaAccessRoles";

      // --- DUMMY DATA (Now storing Permission IDs) ---
      let dummyRoles = [
        {
          id: 1,
          name: "System Admin",
          description: "Full access to all modules and configurations.",
          permissionIds: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], // All 14 permissions
        },
        {
          id: 2,
          name: "Teacher",
          description:
            "Access to academic records of assigned classes (Read/Edit only).",
          permissionIds: [5, 6, 8], // Manage Classes, View Students, Edit Student
        },
        {
          id: 3,
          name: "Accountant",
          description: "Full access to financial and fee collection modules.",
          permissionIds: [10, 11, 12], // View Fees, Collect Fee, Manage Expenses
        },
      ];

      // Initialize/Load Roles from localStorage (Restored to load/save)
      function loadRoles() {
        const storedRoles = localStorage.getItem(ACCESS_STORAGE_KEY);
        if (storedRoles) {
          try {
            dummyRoles = JSON.parse(storedRoles);
          } catch (e) {
            console.error("Error loading access roles:", e);
          }
        } else {
          saveRoles();
        }
      }

      // Save Roles to localStorage
      function saveRoles() {
        localStorage.setItem(ACCESS_STORAGE_KEY, JSON.stringify(dummyRoles));
      }

      // --- Multilingual Data (Updated to reflect API modules) ---
      const langData = {
        en: {
          admin_title: "Admin Panel",
          page_title: "Access Control",
          description:
            "Manage user roles and define module permissions (Read, Create, Update, Delete).",
          back_to_admin: "Back to Admin",
          logout: "Logout",
          search_placeholder: "Search by Role Name...",
          add_new: "Add New Role",
          permissions: "Permissions", // New key for the count display

          // Table Headers
          id: "ID",
          role_name: "Role Name",
          description_short: "Description",
          actions: "Actions",
          view: "View",
          edit: "Edit",
          delete: "Delete",

          // Modules (API Categories)
          Academic: "Academic",
          Finance: "Finance", // NEW
          Staff: "Staff", // NEW
          select_all: "Select All",
          deselect_all: "Deselect All",

          // Modal
          modal_add_title: "Define New User Role",
          modal_edit_title: "Edit Role Permissions",
          modal_view_title: "View Role Permissions",
          role_name_form: "Role Name",
          role_description: "Role Description",
          permissions_matrix: "Module Permissions",
          save: "Save Role",
          cancel: "Cancel",
          form_success_add: "New Role defined successfully!",
          form_success_edit: "Role updated successfully!",
          confirm_delete:
            "Are you sure you want to delete this Role? All users assigned this role will lose access.",
          prompt_name: "Please enter a Role Name.",
        },
        hi: {
          admin_title: "एडमिन पैनल",
          page_title: "पहुँच नियंत्रण",
          description:
            "उपयोगकर्ता भूमिकाएँ प्रबंधित करें और मॉड्यूल अनुमतियाँ परिभाषित करें।",
          back_to_admin: "एडमिन पर वापस",
          logout: "लॉगआउट",
          search_placeholder: "भूमिका नाम से खोजें...",
          add_new: "नई भूमिका जोड़ें",
          permissions: "अनुमतियां",

          // Table Headers
          id: "आईडी",
          role_name: "भूमिका का नाम",
          description_short: "विवरण",
          actions: "कार्यवाही",
          view: "देखें",
          edit: "संपादित करें",
          delete: "हटाएँ",

          // Modules (API Categories)
          Academic: "शैक्षणिक",
          Finance: "वित्त",
          Staff: "कर्मचारी",
          select_all: "सभी चुनें",
          deselect_all: "सभी हटाएँ",

          // Modal
          modal_add_title: "नई उपयोगकर्ता भूमिका परिभाषित करें",
          modal_edit_title: "भूमिका अनुमतियाँ संपादित करें",
          modal_view_title: "भूमिका अनुमतियाँ देखें",
          role_name_form: "भूमिका का नाम",
          role_description: "भूमिका का विवरण",
          permissions_matrix: "माड्यूल अनुमतियाँ",
          save: "भूमिका सहेजें",
          cancel: "रद्द करें",
          form_success_add: "नई भूमिका सफलतापूर्वक परिभाषित की गई!",
          form_success_edit: "भूमिका सफलतापूर्वक अपडेट की गई!",
          confirm_delete:
            "क्या आप निश्चित रूप से यह भूमिका हटाना चाहते हैं? इस भूमिका को सौंपे गए सभी उपयोगकर्ता पहुँच खो देंगे।",
          prompt_name: "कृपया भूमिका का नाम दर्ज करें।",
        },
        ur: {
          admin_title: "ایڈمن پینل",
          page_title: "رسائی کنٹرول",
          description:
            "صارف کے کرداروں کا نظم کریں اور ماڈیول کی اجازتوں کی وضاحت کریں۔",
          back_to_admin: "ایڈمن پر واپس جائیں",
          logout: "لاگ آؤٹ",
          search_placeholder: "کردار کے نام سے تلاش کریں...",
          add_new: "نیا کردار شامل کریں",
          permissions: "اجازتیں",

          // Table Headers
          id: "آئی ڈی",
          role_name: "کردار کا نام",
          description_short: "تفصیل",
          actions: "عمل",
          view: "دیکھیں",
          edit: "ترمیم کریں",
          delete: "حذف کریں",

          // Modules (API Categories)
          Academic: "تعلیمی",
          Finance: "فنانس",
          Staff: "عملہ",
          select_all: "تمام کو منتخب کریں",
          deselect_all: "تمام کو غیر منتخب کریں",

          // Modal
          modal_add_title: "نیا صارف کردار متعین کریں",
          modal_edit_title: "کردار کی اجازتوں میں ترمیم کریں",
          modal_view_title: "کردار کی اجازتیں دیکھیں",
          role_name_form: "کردار کا نام",
          role_description: "کردار کی تفصیل",
          permissions_matrix: "ماڈیول اجازتیں",
          save: "کردار محفوظ کریں",
          cancel: "منسوخ کریں",
          form_success_add: "نیا کردار کامیابی سے بیان کیا گیا!",
          form_success_edit: "کردار کامیابی سے اپ ڈیٹ ہو گیا!",
          confirm_delete:
            "کیا آپ واقعی یہ کردار حذف کرنا چاہتے ہیں؟ اس کردار کو تفویض کردہ تمام صارفین تک رسائی ختم ہو جائے گی۔",
          prompt_name: "براہ کرم کردار کا نام درج کریں۔",
        },
      };

      let currentLang = "en";

      function getTranslation(key) {
        return langData[currentLang][key] || langData["en"][key] || key;
      }

      // Helper to get role by ID
      function getRoleById(id) {
        return dummyRoles.find((role) => role.id === id);
      }

      function updateContent() {
        document.body.className = "lang-" + currentLang;

        document.querySelectorAll("[data-lang-key]").forEach((el) => {
          const key = el.getAttribute("data-lang-key");
          el.textContent = getTranslation(key);
        });

        renderTable(filterRoles());
      }

      function changeLanguage(lang) {
        if (lang in langData) {
          currentLang = lang;
          // localStorage.setItem('madarsaSystemLang', lang); // Keeping localStorage commented for Canvas environment
          updateContent();
        }
      }

      // --- Table Rendering ---
      function renderTable(roleList) {
        const tbody = document.getElementById("roles-table-body");
        if (!tbody) return;
        tbody.innerHTML = "";

        roleList.forEach((role) => {
          const tr = document.createElement("tr");
          const descriptionDisplay =
            role.description.substring(0, 70) +
            (role.description.length > 70 ? "..." : "");

          tr.innerHTML = `
                    <td>${role.id}</td>
                    <td class="font-bold text-gray-800">${role.name}</td>
                    <td>${descriptionDisplay}</td>
                    <td>
                        <button onclick="handleAction('view', ${
                          role.id
                        })" class="action-button bg-blue-100 text-blue-700 hover:bg-blue-200">${getTranslation(
            "view"
          )}</button>
                        <button onclick="handleAction('edit', ${
                          role.id
                        })" class="action-button bg-yellow-100 text-yellow-700 hover:bg-yellow-200 ml-2">${getTranslation(
            "edit"
          )}</button>
                        <button onclick="handleAction('delete', ${
                          role.id
                        })" class="action-button delete-button hover:bg-red-200 ml-2">${getTranslation(
            "delete"
          )}</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      // --- Filter Logic ---
      function filterRoles() {
        const searchInput = document.getElementById("search-input");
        const search = searchInput ? searchInput.value.toLowerCase() : "";

        return dummyRoles.filter((role) => {
          const matchesSearch =
            role.name.toLowerCase().includes(search) ||
            role.description.toLowerCase().includes(search);
          return matchesSearch;
        });
      }

      function handleFilter() {
        renderTable(filterRoles());
      }

      // --- Modal Handling ---
      function openAccessModal(titleKey, contentHtml) {
        const modal = document.getElementById("access-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalBody = document.getElementById("modal-body");

        modalTitle.textContent = getTranslation(titleKey);
        modalBody.innerHTML = contentHtml;

        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.remove("opacity-0");
        }, 10);
      }

      function closeAccessModal() {
        const modal = document.getElementById("access-modal");
        modal.classList.add("opacity-0");
        setTimeout(() => {
          modal.classList.add("hidden");
        }, 300);
      }

      // --- Accordion Logic ---
      function toggleAccordion(module) {
        const body = document.getElementById(`accordion-body-${module}`);
        const icon = document.getElementById(`accordion-icon-${module}`);

        if (body && body.classList.contains("hidden-content")) {
          // Expand
          body.classList.remove("hidden-content");
          body.style.maxHeight = body.scrollHeight + "px";
          icon.classList.add("rotate-180");
        } else if (body) {
          // Collapse
          body.style.maxHeight = "0";
          setTimeout(() => {
            body.classList.add("hidden-content");
          }, 100);
          icon.classList.remove("rotate-180");
        }
      }

      function toggleModulePermissions(moduleKey) {
        const selectAllCheckbox = document.getElementById(
          `select-all-${moduleKey}`
        );
        const selectAll = selectAllCheckbox.checked;
        const form = document.getElementById("role-form");

        // Get all permission checkboxes for this module
        form
          .querySelectorAll(`input[data-module="${moduleKey}"][data-perm-id]`)
          .forEach((checkbox) => {
            checkbox.checked = selectAll;
          });

        // Update the text content of the select/deselect button
        const selectAllSpan = selectAllCheckbox.nextElementSibling;
        if (selectAllSpan) {
          selectAllSpan.textContent = getTranslation(
            selectAll ? "deselect_all" : "select_all"
          );
        }
      }

      // --- Content Creators ---

      // NEW: Creates the Accordion structure based on API response
      function createPermissionAccordion(
        rolePermissionIds,
        isReadOnly = false
      ) {
        let accordionHtml = `<div class="space-y-2">`;
        const heldPermissions = new Set(rolePermissionIds);

        MODULES.forEach((moduleKey) => {
          const modulePermissions = PERMISSION_STRUCTURE[moduleKey];
          const moduleTitle = getTranslation(moduleKey);

          // Check how many permissions in this module the role holds
          const modulePermIds = modulePermissions.map((p) => p.id);
          const heldCount = modulePermIds.filter((id) =>
            heldPermissions.has(id)
          ).length;
          const allChecked =
            modulePermIds.length > 0 && heldCount === modulePermIds.length;
          const checkboxStatus = allChecked ? "checked" : "";
          const displayActionText = allChecked ? "deselect_all" : "select_all";

          // --- Accordion Header ---
          accordionHtml += `
                    <div class="accordion-header flex justify-between items-center transition-all duration-200 rounded-lg shadow-sm"
                         onclick="toggleAccordion('${moduleKey}')">
                        <h4 class="font-semibold text-base" style="color: var(--color-text-dark);">${moduleTitle}</h4>
                        <div class="flex items-center space-x-4">
                            ${
                              !isReadOnly
                                ? // Editable Select All Checkbox
                                  `<label class="permission-checkbox-item text-sm font-medium mr-4" onclick="event.stopPropagation()">
                                     <input type="checkbox" id="select-all-${moduleKey}" 
                                            class="form-checkbox h-4 w-4 text-primary rounded" ${checkboxStatus}
                                            onchange="toggleModulePermissions('${moduleKey}')" data-module-perms="${modulePermIds.join(
                                    ","
                                  )}" style="color: var(--color-primary);">
                                     <span class="ml-2 ${
                                       currentLang === "ur" ? "mr-2" : ""
                                     }" data-lang-key="${displayActionText}">${getTranslation(
                                    displayActionText
                                  )}</span>
                                 </label>`
                                : // Read-Only Permission Count
                                  `<span class="text-sm font-medium text-gray-500">${heldCount} / ${
                                    modulePermIds.length
                                  } ${getTranslation("permissions")}</span>`
                            }
                            
                            <svg id="accordion-icon-${moduleKey}" class="w-5 h-5 text-gray-500 transform transition-transform duration-300" 
                                 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                `;

          // --- Accordion Body (Specific Permissions) ---
          accordionHtml += `<div id="accordion-body-${moduleKey}" class="accordion-body hidden-content">`;
          accordionHtml += `<div class="permission-item-grid">`; // Use the custom grid

          modulePermissions.forEach((perm) => {
            const checked = heldPermissions.has(perm.id) ? "checked" : "";
            const inputId = `perm-${perm.id}`;

            if (isReadOnly) {
              const status = heldPermissions.has(perm.id) ? "✅" : "❌";
              accordionHtml += `<div class="permission-checkbox-item text-sm font-medium">
                                            <span class="mr-2 ${
                                              currentLang === "ur" ? "ml-2" : ""
                                            } text-lg">${status}</span>
                                            <span>${perm.name}</span>
                                          </div>`;
            } else {
              accordionHtml += `
                            <label for="${inputId}" class="permission-checkbox-item cursor-pointer">
                                <input type="checkbox" id="${inputId}" data-perm-id="${
                perm.id
              }" data-module="${moduleKey}"
                                       class="form-checkbox h-4 w-4 text-primary rounded" ${checked} style="color: var(--color-primary);">
                                <span class="ml-2 ${
                                  currentLang === "ur" ? "mr-2" : "ml-2"
                                } text-sm font-medium">${perm.name}</span>
                            </label>
                        `;
            }
          });

          accordionHtml += `</div></div>`;
        });

        accordionHtml += `</div>`;
        return accordionHtml;
      }

      function createRoleForm(role = null) {
        const isEdit = role !== null;
        const isRtl = currentLang === "ur";
        const alignment = isRtl ? "text-right" : "text-left";
        const currentPermissionIds = isEdit ? role.permissionIds : [];

        return `
                <form id="role-form" onsubmit="return saveRoleDetails(event, ${
                  isEdit ? role.id : "null"
                })" class="${alignment}">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-8">
                        
                        <!-- Role Name -->
                        <div class="form-group">
                            <label for="role-name" class="form-label">${getTranslation(
                              "role_name_form"
                            )}</label>
                            <input type="text" id="role-name" class="form-input" value="${
                              isEdit ? role.name : ""
                            }" required>
                        </div>
                        
                        <!-- Role Description (Full Width) -->
                        <div class="form-group md:col-span-2">
                            <label for="role-description" class="form-label">${getTranslation(
                              "role_description"
                            )}</label>
                            <textarea id="role-description" class="form-textarea h-20">${
                              isEdit ? role.description : ""
                            }</textarea>
                        </div>
                    </div>

                    <!-- Permissions Matrix (Accordion) -->
                    <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang-key="permissions_matrix">${getTranslation(
                      "permissions_matrix"
                    )}</h3>
                    ${createPermissionAccordion(currentPermissionIds, false)}

                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeAccessModal()" class="action-button bg-gray-200 text-gray-700 hover:bg-gray-300">${getTranslation(
                          "cancel"
                        )}</button>
                        <button type="submit" class="primary-button">${getTranslation(
                          "save"
                        )}</button>
                    </div>
                </form>
            `;
      }

      function createViewContent(role) {
        const isRtl = currentLang === "ur";
        const alignment = isRtl ? "text-right" : "text-left";

        return `
                <div class="space-y-4 ${alignment}">
                    <h2 class="text-2xl font-bold text-gray-800">${
                      role.name
                    }</h2>
                    <p class="text-gray-500">${getTranslation(
                      "role_description"
                    )}: ${role.description}</p>

                    <div class="border-t pt-4">
                        <h3 class="text-lg font-bold mb-3 text-gray-700">${getTranslation(
                          "permissions_matrix"
                        )}</h3>
                        ${createPermissionAccordion(role.permissionIds, true)}
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button onclick="handleAction('edit', ${
                          role.id
                        })" class="action-button bg-yellow-100 text-yellow-700 hover:bg-yellow-200">${getTranslation(
          "edit"
        )}</button>
                    </div>
                </div>
            `;
      }

      // --- Action Dispatcher (Add/View/Edit/Delete) ---
      function handleAction(action, id) {
        const role = id ? getRoleById(id) : null;

        if (action === "add") {
          openAccessModal("modal_add_title", createRoleForm(null));
        } else if (!role && action !== "add") {
          console.error(`Role not found with ID: ${id}`);
          return;
        } else if (action === "view") {
          openAccessModal("modal_view_title", createViewContent(role));
        } else if (action === "edit") {
          openAccessModal("modal_edit_title", createRoleForm(role));
        } else if (action === "delete") {
          if (confirm(getTranslation("confirm_delete"))) {
            deleteRole(id);
          }
        }
      }

      // --- Delete Logic ---
      function deleteRole(id) {
        dummyRoles = dummyRoles.filter((r) => r.id !== id);
        saveRoles();
        handleFilter();
        console.log(`Role ID ${id} deleted successfully.`);
      }

      // --- Save Logic (Add/Edit) ---
      function saveRoleDetails(event, id) {
        event.preventDefault();

        const form = event.target;
        const name = form.querySelector("#role-name").value.trim();
        const description = form
          .querySelector("#role-description")
          .value.trim();

        if (!name) {
          console.log(getTranslation("prompt_name"));
          return false;
        }

        // 1. Gather permission IDs from the form
        const newPermissionIds = [];
        form
          .querySelectorAll('input[type="checkbox"][data-perm-id]:checked')
          .forEach((input) => {
            newPermissionIds.push(parseInt(input.getAttribute("data-perm-id")));
          });

        if (id) {
          // EDIT LOGIC
          const roleIndex = dummyRoles.findIndex((r) => r.id === id);
          if (roleIndex !== -1) {
            dummyRoles[roleIndex] = {
              ...dummyRoles[roleIndex],
              name,
              description,
              permissionIds: newPermissionIds, // Store IDs array
            };
            console.log(getTranslation("form_success_edit"));
          }
        } else {
          // ADD LOGIC
          const maxId =
            dummyRoles.length > 0
              ? Math.max(...dummyRoles.map((r) => r.id))
              : 0;
          const newId = maxId + 1;
          const newRole = {
            id: newId,
            name,
            description,
            permissionIds: newPermissionIds, // Store IDs array
          };
          dummyRoles.unshift(newRole);
          console.log(getTranslation("form_success_add"));
        }

        saveRoles();
        closeAccessModal();
        updateContent(); // Update filters and table
        return false;
      }

      // Initialize content and language
      window.onload = function () {
        loadRoles(); // Load data

        // Load language from storage (if available)
        const storedLang = localStorage.getItem("madarsaSystemLang");
        currentLang = storedLang && storedLang in langData ? storedLang : "en";

        // Initial content update and table render
        updateContent();

        // Attach event listeners to filters
        const searchInput = document.getElementById("search-input");
        if (searchInput) {
          searchInput.addEventListener("input", handleFilter);
        }
      };
    </script>

    <!-- HEADER -->
    <header>
      <div class="max-w-7xl mx-auto w-full flex justify-between items-center">
        <!-- Left: Back Button & Title -->
        <div class="flex items-center space-x-4">
          <a
            href="administration.html"
            class="action-button bg-gray-100 text-gray-700 hover:bg-gray-200"
            data-lang-key="back_to_admin"
            >Back to Admin</a
          >
          <h1
            class="text-xl font-bold"
            data-lang-key="page_title"
            style="color: var(--color-primary)"
          >
            Access Control
          </h1>
        </div>

        <!-- Right: Language Switch -->
        <div class="flex items-center space-x-2">
          <select
            onchange="changeLanguage(this.value)"
            class="bg-gray-100 rounded-lg p-1 text-sm"
          >
            <option value="en" selected>English</option>
            <option value="hi">हिन्दी</option>
            <option value="ur">اردو</option>
          </select>
          <button
            onclick="window.location.href='login.html'"
            class="text-sm font-semibold text-red-600 hover:text-red-800 transition-colors ml-4"
            data-lang-key="logout"
          >
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="max-w-7xl mx-auto w-full p-4 md:p-8">
      <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
        <!-- Description and Action Button -->
        <div
          class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0"
        >
          <div>
            <h2
              class="text-2xl font-bold text-gray-700"
              data-lang-key="page_title"
            >
              Access Control
            </h2>
            <p class="text-gray-500 mt-1 text-sm" data-lang-key="description">
              Manage user roles and define module permissions (Read, Create,
              Update, Delete).
            </p>
          </div>

          <!-- Add New Button - Opens Modal -->
          <button
            onclick="handleAction('add', null)"
            class="primary-button flex items-center space-x-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4v16m8-8H4"
              />
            </svg>
            <span data-lang-key="add_new">Add New Role</span>
          </button>
        </div>

        <!-- Filter and Search Controls -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-8">
          <!-- Search -->
          <div class="sm:col-span-4 relative">
            <input
              type="text"
              id="search-input"
              class="form-input pl-10"
              data-lang-key="search_placeholder"
              placeholder="Search by Role Name..."
            />
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>
        </div>

        <!-- Roles Table -->
        <div class="table-container">
          <table class="admin-table">
            <thead>
              <tr class="bg-gray-100 rounded-lg">
                <th data-lang-key="id">ID</th>
                <th data-lang-key="role_name">Role Name</th>
                <th data-lang-key="description_short">Description</th>
                <th data-lang-key="actions">Actions</th>
              </tr>
            </thead>
            <tbody id="roles-table-body">
              <!-- Roles data will be injected here by JS -->
            </tbody>
          </table>
        </div>

        <div class="text-center text-sm text-gray-500 mt-6">
          Showing 1 to 3 of 3 entries (Note: This text is static in this
          version)
        </div>
      </div>
    </main>

    <!-- ACCESS CONTROL VIEW/EDIT/ADD MODAL -->
    <div
      id="access-modal"
      class="hidden opacity-0 fixed inset-0 z-50 flex items-center justify-center modal-backdrop transition-opacity duration-300"
    >
      <div
        class="modal-content p-6 md:p-8 transform scale-100 transition-transform duration-300"
        style="border: 3px solid var(--color-primary)"
      >
        <div class="flex justify-between items-start pb-4 border-b mb-6">
          <h3 id="modal-title" class="text-xl font-bold text-gray-700">
            Role Permissions
          </h3>
          <button
            onclick="closeAccessModal()"
            class="text-gray-500 hover:text-gray-900 transition-colors p-1"
            aria-label="Close"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-6 h-6"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div id="modal-body">
          <!-- Dynamic content (View or Edit/Add Form) goes here -->
        </div>
      </div>
    </div>
  </body>
</html>
